#!/usr/bin/env bash

# Steps:
# 1. wget this file under ~ and run the following with the correct host name.
#   ./checkout node TheWizardsOfOrd/ord main node2.wizards.art
#
# 2. Download prebuilt ord index torrent with tmux
#   $ wget <torrent>
#   $ tmux new -s ordstuff
#   $ aria2c <torrent>
#   <Ctrl + b, then d> to exit tmux. `tmux attach -t ordstuff` to check up on it.
#   ...few hours later..
#
# 3. Make sure bitcoin node has caught up and ord index file has downloaded.
#   $ bitcoin-cli getblockchaininfo
#
# 4. Setup ord
#   $ mkdir -p /var/lib/ord
#   $ cp <index.redb> /var/lib/ord/index.redb
#   $ chown -R ord:ord /var/lib/ord
#   <run ./deploy/setup with last argument as false>
#
# To check logs:
#   $ journalctl -u bitcoind.service
#   $ journalctl -u ord.service -f

set -euxo pipefail

BRANCH=$1
REMOTE=$2
CHAIN=$3
DOMAIN=$4

apt-get update
apt-get -y install git aria2 tmux

if [[ ! -d $REMOTE ]]; then
  mkdir -p $REMOTE
  git clone https://github.com/$REMOTE.git $REMOTE
fi

cd $REMOTE

git fetch origin
git checkout -B $BRANCH
git reset --hard origin/$BRANCH

COMMIT=$(git rev-parse --short HEAD)

# ./deploy/setup main node1.wizards.art node $(git rev-parse --short HEAD) false
./deploy/setup $CHAIN $DOMAIN $BRANCH $COMMIT "true"
